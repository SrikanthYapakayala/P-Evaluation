<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Employee Performance Evaluation Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

    <style>
        :root {
            --border: #dee2e6;
            --border-soft: #e9ecef;
            --bg-page: #f8f9fa;
            --bg-light: #f1f3f5;
            --accent: #0056b3;
            --accent-soft: #e3f2fd;
            --text-main: #343a40;
            --text-muted: #6c757d;
            --danger: #dc3545;
            --header-bg: #212529;
            --header-text: #ffffff;
            --card-header-bg: #c62828; /* Original Red */
            --shadow-light: 0 6px 20px rgba(0, 0, 0, 0.1);
            --form-border-strong: #adb5bd;
            --rating-active-bg: #c83b83;
            --rating-active-border: #c83b83;
            --rating-inactive-border: #adb5bd;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-page);
            color: var(--text-main);
            line-height: 1.5;
        }

        .page {
            max-width: 1000px;
            margin: 40px auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            border: 2px solid var(--form-border-strong);
        }

        /* HEADER */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--header-bg);
            padding-bottom: 15px;
        }
        .page-title {
            margin: 0;
            font-size: 26px;
            text-transform: uppercase;
            color: var(--header-bg);
            font-weight: 700;
        }

        /* BASIC DETAILS */
        .basic-details-card {
            margin-top: 25px;
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .basic-details-header {
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            background: var(--card-header-bg);
            color: var(--header-text);
        }
        .basic-details-body {
            padding: 20px 25px;
            background: var(--bg-light);
        }
        /* GRID LAYOUT */
        .basic-details-grid {
            display: grid;
            grid-template-columns: 110px 1fr 110px 1fr; 
            column-gap: 15px;
            row-gap: 12px;
            align-items: center;
            font-size: 13px;
        }
        .basic-cell-label { font-weight: 600; }
        .basic-cell-label.required::after { content: " *"; color: var(--danger); }
        .basic-cell-input input {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
        }

        /* CUSTOM DATE PICKER STYLES */
        .date-input-container { position: relative; }
        #reviewDateDisplay { background-color: #fff; cursor: pointer; }
        #reviewDateHidden { position: absolute; opacity: 0; width: 1px; height: 1px; bottom: 0; left: 0; z-index: -1; }

        /* SECTIONS & TABLES */
        .section-title {
            margin: 25px 0 10px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            background: var(--header-bg);
            color: var(--header-text);
            border-radius: 8px;
        }
        .section-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--form-border-strong);
        }
        .metrics-table th, .metrics-table td {
            border: 1px solid var(--border-soft);
            padding: 8px 10px;
            vertical-align: middle;
            text-align: left;
        }
        .metrics-table thead th {
            background: var(--bg-light);
            font-weight: 600;
            text-align: center;
            padding: 10px 8px;
            border-bottom: 2px solid var(--border);
        }
        .metrics-table thead th:nth-child(2) { text-align: left; }
        
        .metrics-table .metric-id { text-align: center; width: 4%; }
        .metrics-table .metric-label { font-weight: 500; width: 36%; }
        .metrics-table .rating-cell { text-align: center; width: 8%; }

        /* ORGANIZATIONAL TABLE SPECIFIC STYLES */
        .org-table thead th.org-header-dark {
            background-color: #212529;
            color: white;
            text-transform: uppercase;
            text-align: center;
            font-size: 15px;
            padding: 12px;
        }
        .org-table .org-label-col { width: 45%; font-weight: 600; }
        .org-table .org-data-col { 
            width: 15%; 
            text-align: center; 
            background-color: #fff; 
            font-weight: bold; 
            color: var(--accent); 
            min-height: 25px;
        }
        
        /* Org Headers */
        .org-table thead th.org-rating-head {
            background-color: var(--bg-light); 
            color: var(--text-main); 
            font-size: 12px;
            font-weight: 700;
            width: 10%;
            text-align: center;
        }

        /* YELLOW BADGE STYLE */
        .rating-badge {
            background-color: #ffeb3b; /* Bright Yellow */
            color: #c62828; /* Red/Orange Text */
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #fdd835;
            display: inline-block;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 13px;
        }

        /* RATINGS */
        .rating-label-circle { display: inline-block; position: relative; cursor: pointer; }
        .rating-label-circle input[type="radio"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .rating-label-circle .rating-dot {
            display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 50%;
            border: 2px solid var(--rating-inactive-border);
            font-weight: 600; color: var(--rating-inactive-border);
            transition: all 0.2s ease-in-out;
        }
        .rating-label-circle input[type="radio"]:checked + .rating-dot {
            background-color: var(--rating-active-bg);
            border-color: var(--rating-active-border);
            color: #fff; transform: scale(1.1);
        }
        .rating-dot-na { font-size: 0.8em; padding: 0 4px; }
        .rating-header .rating-title { font-weight: 600; }
        .rating-header .rating-value { color: var(--text-muted); }

        .section-summary-row td {
            font-weight: 600 !important;
            background-color: var(--accent-soft) !important;
            border-top: 2px solid var(--accent) !important;
        }
        .section-summary-value { font-weight: 700; color: var(--accent); }

        /* INPUTS */
        .full-width-textarea { margin: 18px 0; }
        textarea { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 13px; resize: vertical; min-height: 120px; }

        /* IMPRESSIVE SUMMARY */
        .impressive-summary {
            display: flex;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 2px solid #d1d9e6;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .imp-sum-item {
            flex: 1;
            padding: 25px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .imp-sum-item:last-child { border-right: none; background-color: #fcfcfc; }
        .imp-sum-label {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .imp-sum-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }
        .imp-sum-sub {
            font-size: 12px;
            color: #adb5bd;
            margin-top: 5px;
        }
        .warning { color: var(--danger); font-size: 12px; margin-top: 15px; display: none; font-weight: 600; text-align: center;}

        /* SIGNATURES */
        .signatures { margin-top: 25px; }
        .signature-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .signature-table td { width: 50%; text-align: center; padding: 15px; height: 120px; vertical-align: bottom; }
        .sig-title { font-size: 1.1em; margin-bottom: 8px; }
        .sig-name { display: block; min-height: 24px; padding-top: 8px; border-top: 1px solid var(--text-main); }
       
        .actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 12px; }
        button {
            border-radius: 8px; border: none; padding: 12px 20px; font-size: 14px;
            cursor: pointer; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: #e9ecef; border: 1px solid var(--border); }
        .btn-primary:hover, .btn-secondary:hover { transform: translateY(-2px); }
        
        /* ---------------------------------------------------------
           PDF EXPORT MODE - SPACE SAVING & MARGIN FIXES
        --------------------------------------------------------- */
        .pdf-export {
            background: #fff !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .pdf-export .page {
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 10px 20px !important; /* Reduced Top/Bottom padding */
            border: none !important;
            box-shadow: none !important;
        }
        .pdf-export .actions { display: none !important; }
        
        /* COMPACT BASIC DETAILS FOR PDF TO SAVE VERTICAL SPACE */
        .pdf-export .basic-details-card { margin-top: 15px !important; page-break-inside: auto !important; }
        .pdf-export .basic-details-body { padding: 10px 15px !important; }
        .pdf-export .basic-details-grid { row-gap: 5px !important; font-size: 12px !important; }
        .pdf-export .page-header { margin-bottom: 10px !important; padding-bottom: 10px !important; }
        .pdf-export .section-title { margin: 15px 0 10px !important; padding: 8px 12px !important; }

        /* PREVENT PAGE BREAKS */
        .pdf-export tr { page-break-inside: avoid !important; }
        .pdf-export .section-title { page-break-after: avoid !important; }
        .pdf-export .metrics-table { page-break-inside: auto !important; }
        .pdf-export .impressive-summary { page-break-inside: avoid !important; }
        
        /* PDF TEXT REPLACEMENT CLASS */
        .pdf-text-value {
            display: block;
            width: 100%;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 0;
            color: #000;
            border-bottom: 1px solid #ddd;
        }
        
        /* Ensure Colors Print */
        .pdf-export .rating-dot, .pdf-export .rating-badge, .pdf-export .basic-details-header, .pdf-export .org-header-dark, .pdf-export .section-title { 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
    </style>
</head>
<body>
<div class="page">
    <header class="page-header">
        <div class="page-title-block"><h1 class="page-title">EMPLOYEE PERFORMANCE EVALUATION FORM</h1></div>
    </header>

    <section class="basic-details-card">
        <div class="basic-details-header">BASIC EMPLOYEE DETAILS</div>
        <div class="basic-details-body">
            <div class="basic-details-grid">
                <div class="basic-cell-label required">Employee ID</div>
                <div class="basic-cell-input"><input type="text" id="employeeId" placeholder="Enter ID" /></div>
                
                <div class="basic-cell-label required">Reviewer's ID</div>
                <div class="basic-cell-input"><input type="text" id="reviewerId" placeholder="Enter ID" /></div>
                
                <div class="basic-cell-label required">Employee Name</div>
                <div class="basic-cell-input"><input type="text" id="employeeName" readonly /></div>
                
                <div class="basic-cell-label required">Reviewer Name</div>
                <div class="basic-cell-input"><input type="text" id="reviewerName" /></div>
                
                <div class="basic-cell-label required">Job Text</div>
                <div class="basic-cell-input"><input type="text" id="jobText" readonly /></div>
                
                <div class="basic-cell-label required">Designation</div>
                <div class="basic-cell-input"><input type="text" id="designation" readonly /></div>
                
                <div class="basic-cell-label required">Division Text</div>
                <div class="basic-cell-input"><input type="text" id="divisionText" readonly /></div>
                
                <div class="basic-cell-label required">Department</div>
                <div class="basic-cell-input"><input type="text" id="department" readonly /></div>
                
                <div class="basic-cell-label required">Civil ID Number</div>
                <div class="basic-cell-input"><input type="text" id="civilId" readonly /></div>
                
                <div class="basic-cell-label required">Date of Review</div>
                <div class="basic-cell-input date-input-container">
                    <input type="text" id="reviewDateDisplay" placeholder="Select Date..." readonly />
                    <input type="date" id="reviewDateHidden" />
                </div>
            </div>
        </div>
    </section>

    <!-- TECHNICAL -->
    <div class="section-title">TECHNICAL SKILLS EVALUATION</div>
    <div class="section-subtitle">Rate each competency (0 = Poor, 1 = Satisfactory, 2 = Good, 3 = Very Good, 4 = Excellent, or NA).</div>
    <table class="metrics-table" id="technicalMetricsTable"></table>

    <!-- BEHAVIOURAL -->
    <div class="section-title">BEHAVIOURAL COMPETENCIES EVALUATION</div>
    <table class="metrics-table" id="behaviouralMetricsTable"></table>

    <!-- ORGANIZATIONAL -->
    <div style="margin-top: 25px;"></div>
    <table class="metrics-table org-table" id="organizationalMetricsTable"></table>

    <!-- FEEDBACK -->
    <div class="section-title">REVIEWER FEEDBACK</div>
    <div class="full-width-textarea">
        <div>
            <textarea id="reviewerFeedback" placeholder="Reviewer comments..."></textarea>
        </div>
    </div>

    <!-- SUMMARY -->
    <div class="section-title">PERFORMANCE SUMMARY</div>
    <div class="impressive-summary">
        <div class="imp-sum-item">
            <div class="imp-sum-label">Overall Percentage</div>
            <div class="imp-sum-value" id="performancePercent">0.0%</div>
            <div class="imp-sum-sub">Weighted Score</div>
        </div>
        <div class="imp-sum-item">
            <div class="imp-sum-label">Performance Rating</div>
            <div class="imp-sum-value" id="performanceText">Not Rated</div>
            <div class="imp-sum-sub">Final Band</div>
        </div>
    </div>
    <div id="scoreWarning" class="warning">Please rate all applicable metrics to finalize the evaluation.</div>

    <div class="section-title">SIGNATURES</div>
    <div class="signatures">
        <table class="signature-table">
            <tbody>
                <tr>
                    <td><div class="sig-title"><strong><u>Reviewer</u></strong></div><span class="sig-name" id="sigReviewerName">[Reviewer Name]</span></td>
                    <td><div class="sig-title"><strong><u>Division Head</u></strong></div><span class="sig-name" id="sigDivisionHeadName">[Division Head Name]</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="actions">
        <button type="button" class="btn-secondary" id="btnClear">Clear Form</button>
        <button type="button" class="btn-primary" id="btnCalculate">Recalculate Score</button>
        <button type="button" class="btn-primary" id="btnSavePdf">Save as PDF</button>
    </div>
</div>

<script>
    // General Constants
    const NA_VALUE = -1;
    const MIN_RATING_VALUE = 0;
    const MAX_RATING_VALUE = 4;
    const RATING_LABELS = { 0: "Poor", 1: "Satisfactory", 2: "Good", 3: "Very Good", 4: "Excellent" };
    
    // Org Specific Constants
    const ORG_SCORE_MAP = { "poor": 0, "satisfactory": 1, "good": 2, "excellent": 3 };
    const ORG_LABELS_TEXT = ["Poor", "Satisfactory", "Good", "Excellent"];
    const MAX_ORG_RATING = 3;

    // ----- SECTION CONFIGURATION -----
    const sections = {
        technical: {
            id: 'technicalMetricsTable', weightage: 0.30, achievedId: 'techAchievedPercent',
            metrics: [
                { id: "tech_quality", label: "Quality of Work" }, 
                { id: "tech_efficiency", label: "Efficiency and Productivity" },
                { id: "tech_tools", label: "Use of Tools and Technology" }, 
                { id: "tech_data", label: "Data Analysis & Reporting" },
                { id: "tech_process", label: "Process Improvement" }, 
                { id: "tech_project", label: "Project & Task Management" },
                { id: "tech_docs", label: "Technical Documentation" }, 
                { id: "tech_standards", label: "Adherence to Standards & Best Practices" }
            ]
        },
        behavioural: {
            id: 'behaviouralMetricsTable', weightage: 0.20, achievedId: 'behAchievedPercent',
            metrics: [
                { id: "beh_comm", label: "Communication" }, 
                { id: "beh_team", label: "Teamwork & Collaboration" },
                { id: "beh_problem", label: "Problem Solving & Decision Making" }, 
                { id: "beh_adapt", label: "Adaptability & Flexibility" },
                { id: "beh_initiative", label: "Initiative & Proactivity" }, 
                { id: "beh_account", label: "Accountability & Ownership" },
                { id: "beh_prof", label: "Professionalism & Work Ethics" }
            ]
        },
        organizational: {
            id: 'organizationalMetricsTable',
            weightage: 0.50,
            achievedId: 'orgAchievedPercent',
            metrics: [
                { label: "HR Attitude Scorecard", dataKey: "hrScorecard" },
                { label: "1. No. of days not available at work", dataKey: "absentDays" },
                { label: "2. No. of warning letters issued", dataKey: "warningLetters" },
                { label: "3. No. of instances of short working hours", dataKey: "shortHours" },
                { label: "4. Average PI for the year (if applicable)", dataKey: "averagePI" }
            ]
        }
    };

    let employeeDataStore = new Map();
    let currentEmployeeRecord = null;
    let currentOrgScoreValue = 0; 

    // ----- DATE PICKER HANDLER -----
    function setupDatePicker() {
        const displayInput = document.getElementById("reviewDateDisplay");
        const hiddenInput = document.getElementById("reviewDateHidden");

        displayInput.addEventListener("click", () => {
            try { hiddenInput.showPicker(); } catch (e) { hiddenInput.click(); }
        });

        hiddenInput.addEventListener("change", (e) => {
            const val = e.target.value; 
            if (val) {
                const dateParts = val.split("-");
                const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                const day = String(dateObj.getDate()).padStart(2, '0');
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const month = months[dateObj.getMonth()];
                const year = dateObj.getFullYear();
                displayInput.value = `${day}-${month}-${year}`;
            }
        });
    }

    // ----- DATA FETCHING -----
    async function fetchEmployeeData() {
        const webAppUrl = "https://script.google.com/macros/s/AKfycbyPx9llzANWMGHPgmbz3W2UznPr7MHM40DGTU9i-q7QFEdNcP1r1QVoKPYaBuxkNdPn/exec"; 

        try {
            const response = await fetch(webAppUrl);
            if (!response.ok) throw new Error(`Server status: ${response.status}`);
            
            const jsonData = await response.json();
            if (jsonData.error) throw new Error(jsonData.error);
            if(!Array.isArray(jsonData)) throw new Error("Invalid format.");

            jsonData.forEach(employee => {
                const idVal = employee["Personnel Number"];
                if (!idVal) return;
                const empId = String(idVal).trim();
                
                employeeDataStore.set(empId, {
                    // BASIC DETAILS
                    name: employee["Name"] || "",
                    jobText: employee["Job Text"] || "",
                    designation: employee["Designation"] || "",
                    divisionText: employee["Division Text"] || "",
                    department: employee["Department Text"] || "", 
                    civilId: employee["Civil Number"] || "",
                    
                    // ORGANIZATIONAL DATA
                    hrScorecard: employee["HR Attitude Scorecard"],
                    absentDays: employee["No. of days not available at work"], 
                    warningLetters: employee["No. of warning letters issued"],
                    shortHours: employee["No. of instances of short working hours"],
                    averagePI: employee["Average PI for the year (if applicable)"],
                    
                    // SCORE BAND (The driver for Org Score)
                    scoreBand: employee["Score Band"] || ""
                });
            });
            console.log(`Stored ${employeeDataStore.size} employees.`);
        } catch (error) {
            console.error('Fetch Error:', error);
            alert("Error fetching data. Check console.");
        }
    }

    function populateEmployeeDetails(idInput) {
        const id = String(idInput).trim();
        const data = employeeDataStore.get(id) || null;
        currentEmployeeRecord = data; 

        // Clear Org Data
        document.querySelectorAll('.org-data-display').forEach(td => td.textContent = "");
        for(let i=0; i<=3; i++) {
            const cell = document.getElementById(`org-rating-cell-${i}`);
            if(cell) cell.innerHTML = "";
        }

        if (data) {
            // Basic
            document.getElementById("employeeName").value = data.name || "";
            document.getElementById("jobText").value = data.jobText || "";
            document.getElementById("designation").value = data.designation || "";
            document.getElementById("divisionText").value = data.divisionText || "";
            document.getElementById("department").value = data.department || "";
            document.getElementById("civilId").value = data.civilId || "";

            // Populate org table data rows
            document.querySelectorAll('.org-data-display').forEach(td => {
                const key = td.getAttribute('data-key'); 
                const val = data[key];
                if (val !== undefined && val !== null && val !== "") {
                    td.textContent = val;
                } else {
                    td.textContent = "-"; 
                }
            });

            // Handle Auto-Rating based on Score Band
            if (data.scoreBand) {
                const lowerBand = data.scoreBand.toLowerCase().trim();
                let numericScore = ORG_SCORE_MAP[lowerBand];
                
                // Fallback Logic
                if (numericScore === undefined) {
                    if (lowerBand.includes("excellent")) numericScore = 3;
                    else if (lowerBand.includes("good") && !lowerBand.includes("very")) numericScore = 2; 
                    else if (lowerBand.includes("satisfactory")) numericScore = 1;
                    else if (lowerBand.includes("poor")) numericScore = 0;
                }

                if (numericScore !== undefined) {
                    currentOrgScoreValue = numericScore;
                    // Inject Yellow Badge
                    const targetCell = document.getElementById(`org-rating-cell-${numericScore}`);
                    if(targetCell) {
                        const labelText = ORG_LABELS_TEXT[numericScore];
                        targetCell.innerHTML = `<div class="rating-badge">${labelText} (${numericScore})</div>`;
                    }
                } else {
                    currentOrgScoreValue = 0; 
                }
            } else {
                currentOrgScoreValue = 0;
            }

        } else {
            // Clear fields
            document.getElementById("employeeName").value = "";
            document.getElementById("jobText").value = "";
            document.getElementById("designation").value = "";
            document.getElementById("divisionText").value = "";
            document.getElementById("department").value = "";
            document.getElementById("civilId").value = "";
            currentOrgScoreValue = 0;
        }

        calculateScore();
    }

    function populateReviewerDetails(idInput) {
        const id = String(idInput).trim();
        const data = employeeDataStore.get(id);
        if (data) {
            document.getElementById("reviewerName").value = data.name;
        } else if(id.length === 0) {
            document.getElementById("reviewerName").value = "";
        }
        syncSignatureNames();
    }

    // ----- TABLE BUILDERS -----
    function buildStandardRatingTable(tableId, sectionData) {
        const table = document.getElementById(tableId);
        let html = '<thead><tr><th class="metric-id">#</th><th class="metric-label">Competency</th>';
        for (let i = MIN_RATING_VALUE; i <= MAX_RATING_VALUE; i++) {
            html += `<th class="rating-header"><span class="rating-title">${RATING_LABELS[i]}</span><br><span class="rating-value">(${i})</span></th>`;
        }
        html += `<th class="rating-header"><span class="rating-title">Not Applicable</span><br><span class="rating-value">(NA)</span></th></tr></thead><tbody>`;
        
        sectionData.metrics.forEach((metric, index) => {
            html += `<tr><td class="metric-id">${index + 1}</td><td class="metric-label">${metric.label}</td>`;
            for (let i = MIN_RATING_VALUE; i <= MAX_RATING_VALUE; i++) {
                html += `<td class="rating-cell"><label class="rating-label-circle"><input type="radio" name="${metric.id}" value="${i}"><span class="rating-dot">${i}</span></label></td>`;
            }
            html += `<td class="rating-cell"><label class="rating-label-circle"><input type="radio" name="${metric.id}" value="${NA_VALUE}"><span class="rating-dot rating-dot-na">NA</span></label></td></tr>`;
        });

        const colspan = 2 + (MAX_RATING_VALUE - MIN_RATING_VALUE + 1);
        html += `<tr class="section-summary-row"><td colspan="${colspan}">Weightage Percentage</td><td class="section-summary-value">${sectionData.weightage * 100}%</td></tr>`;
        html += `<tr class="section-summary-row"><td colspan="${colspan}">Achieved Percentage (out of Weightage)</td><td class="section-summary-value" id="${sectionData.achievedId}">0.0%</td></tr></tbody>`;
        
        table.innerHTML = html;
    }

    function buildOrganizationalTable(tableId, sectionData) {
        const table = document.getElementById(tableId);
        
        let html = '<thead><tr>';
        html += '<th colspan="2" class="org-header-dark">ORGANISATIONAL COMPLIANCE</th>';
        
        // 0 to 3 Scale headers (Plain)
        html += '<th class="org-rating-head">Poor<br>(0)</th>';
        html += '<th class="org-rating-head">Satisfactory<br>(1)</th>';
        html += '<th class="org-rating-head">Good<br>(2)</th>';
        html += '<th class="org-rating-head">Excellent<br>(3)</th>';
        html += '</tr></thead><tbody>';

        // Display Data Rows
        sectionData.metrics.forEach((metric, index) => {
            html += '<tr>';
            html += `<td class="org-label-col">${metric.label}</td>`;
            html += `<td class="org-data-col org-data-display" data-key="${metric.dataKey}"></td>`;
            
            // For the first row (HR Attitude Scorecard), create specific cells for the Rating Badge
            if (index === 0) {
                 html += `<td class="rating-cell" id="org-rating-cell-0" style="background-color:#f8f9fa;"></td>`;
                 html += `<td class="rating-cell" id="org-rating-cell-1" style="background-color:#f8f9fa;"></td>`;
                 html += `<td class="rating-cell" id="org-rating-cell-2" style="background-color:#f8f9fa;"></td>`;
                 html += `<td class="rating-cell" id="org-rating-cell-3" style="background-color:#f8f9fa;"></td>`;
            } else {
                 html += `<td colspan="4" style="background-color:#f8f9fa;"></td>`;
            }
            html += '</tr>';
        });

        html += `<tr class="section-summary-row"><td colspan="2">Weightage Percentage</td><td colspan="4" class="section-summary-value" style="text-align:right; padding-right:15px;">${sectionData.weightage * 100}%</td></tr>`;
        html += `<tr class="section-summary-row"><td colspan="2">Achieved Percentage (out of Weightage)</td><td colspan="4" class="section-summary-value" style="text-align:right; padding-right:15px;" id="${sectionData.achievedId}">0.0%</td></tr></tbody>`;

        table.innerHTML = html;
    }
    
    // ----- SCORING & UTILS -----
    function calculateScore() {
        let overallWeightedPercentage = 0;
        let totalRatedComponents = 0; 

        // 1. Technical & Behavioural Calculation
        const standardSections = [sections.technical, sections.behavioural];
        standardSections.forEach(section => {
            let sectionScore = 0;
            // NEW CALCULATION LOGIC:
            // NA means FULL POINTS (4), unless ALL are NA.
            let totalQuestions = section.metrics.length;
            let naCount = 0;
            
            section.metrics.forEach(metric => {
                const checkedRadio = document.querySelector(`input[name="${metric.id}"]:checked`);
                if (checkedRadio) {
                    const value = parseInt(checkedRadio.value, 10);
                    if (value === NA_VALUE) {
                        sectionScore += 4; // NA counts as 4 points
                        naCount++;
                    } else {
                        sectionScore += value;
                    }
                }
            });

            // If ALL are NA, score is 0
            if(naCount === totalQuestions) {
                sectionScore = 0;
            }

            let maxPotentialScore = totalQuestions * MAX_RATING_VALUE; 

            // Calculate percentage based on (Points Earned / Total Potential Points)
            const sectionPercentage = maxPotentialScore > 0 ? (sectionScore / maxPotentialScore) * 100 : 0;
            const achievedOutOfWeightage = (sectionPercentage / 100) * (section.weightage * 100);
            
            document.getElementById(section.achievedId).textContent = `${achievedOutOfWeightage.toFixed(1)}%`;
            overallWeightedPercentage += achievedOutOfWeightage;
            
            // Only consider it rated if not all are NA or empty
            if(sectionScore > 0 || naCount < totalQuestions) totalRatedComponents++;
        });

        // 2. Organisational Calculation
        let orgPercentage = (currentOrgScoreValue / MAX_ORG_RATING) * 100;
        if(isNaN(orgPercentage)) orgPercentage = 0;
        
        const orgAchieved = (orgPercentage / 100) * (sections.organizational.weightage * 100);
        document.getElementById(sections.organizational.achievedId).textContent = `${orgAchieved.toFixed(1)}%`;
        
        if (currentEmployeeRecord) {
            overallWeightedPercentage += orgAchieved;
            totalRatedComponents += 1;
        }

        // Final Totals
        document.getElementById("performancePercent").textContent = `${overallWeightedPercentage.toFixed(1)}%`;

        let perfText = "Not Rated";
        if (totalRatedComponents > 0) {
            if (overallWeightedPercentage >= 90) perfText = "Excellent";
            else if (overallWeightedPercentage >= 75) perfText = "Very Good";
            else if (overallWeightedPercentage >= 60) perfText = "Good";
            else if (overallWeightedPercentage >= 40) perfText = "Satisfactory";
            else perfText = "Poor";
        }
        document.getElementById("performanceText").textContent = perfText;
    }
    
    function clearForm() {
        document.querySelectorAll('input[type="text"], textarea').forEach(input => input.value = "");
        document.getElementById("reviewDateHidden").value = ""; 
        document.getElementById("reviewDateDisplay").value = "";
        
        // Clear Tech/Behav radios
        document.querySelectorAll('input[type="radio"]:not([disabled])').forEach(radio => {
            radio.checked = false;
            radio.setAttribute('data-checked', 'false');
        });

        // Clear Org Cells
        document.querySelectorAll('.org-data-display').forEach(td => td.textContent = "");
        for(let i=0; i<=3; i++) {
            const cell = document.getElementById(`org-rating-cell-${i}`);
            if(cell) cell.innerHTML = "";
        }

        currentEmployeeRecord = null;
        currentOrgScoreValue = 0;
        syncSignatureNames();
        calculateScore();
    }
    
    function syncSignatureNames() {
        const revName = document.getElementById("reviewerName").value.trim();
        document.getElementById("sigReviewerName").textContent = revName || "[Reviewer Name]";
    }

    function saveAsPdf() {
        const element = document.querySelector(".page");
        const empName = document.getElementById("employeeName").value.trim() || 'employee';
        
        // 1. Add PDF Class
        document.body.classList.add("pdf-export");

        // 2. TEXT REPLACEMENT MAGIC:
        // Finds all inputs, creates a temporary <span> with the text value, hides the input.
        const inputs = document.querySelectorAll('.basic-cell-input input, .full-width-textarea textarea');
        const replacements = [];

        inputs.forEach(input => {
            const span = document.createElement('span');
            span.className = 'pdf-text-value';
            span.textContent = input.value;
            input.parentNode.insertBefore(span, input);
            input.style.display = 'none'; // Hide input
            replacements.push({ input, span });
        });

        const opt = {
            // REDUCED MARGINS TO 5MM to provide more width
            margin:       [5, 5, 5, 5], 
            filename:     `Performance_Evaluation_${empName}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().from(element).set(opt).save().then(() => {
            // 3. REVERT: Remove spans, show inputs again
            replacements.forEach(rep => {
                rep.span.remove();
                rep.input.style.display = '';
            });
            document.body.classList.remove("pdf-export");
        }).catch((err) => {
            console.error("PDF Failed", err);
            // Revert even on error
            replacements.forEach(rep => { rep.span.remove(); rep.input.style.display = ''; });
            document.body.classList.remove("pdf-export");
        });
    }

    // ----- INIT -----
    document.addEventListener("DOMContentLoaded", () => {
        setupDatePicker();
        
        buildStandardRatingTable(sections.technical.id, sections.technical);
        buildStandardRatingTable(sections.behavioural.id, sections.behavioural);
        buildOrganizationalTable(sections.organizational.id, sections.organizational);
        
        fetchEmployeeData();

        document.getElementById("employeeId").addEventListener("input", (e) => { populateEmployeeDetails(e.target.value); });
        document.getElementById("reviewerId").addEventListener("input", (e) => { populateReviewerDetails(e.target.value); });

        document.addEventListener('click', (e) => {
            const radio = e.target.closest('input[type="radio"]:not([disabled])');
            if (!radio) return;
            if (radio.getAttribute('data-checked') === 'true') {
                radio.checked = false;
                radio.setAttribute('data-checked', 'false');
            } else {
                document.querySelectorAll(`input[name="${radio.name}"]`).forEach(r => r.setAttribute('data-checked', 'false'));
                radio.setAttribute('data-checked', 'true');
            }
            calculateScore();
        });

        document.getElementById("btnCalculate").addEventListener("click", calculateScore);
        document.getElementById("btnClear").addEventListener("click", () => { if (confirm("Clear form?")) clearForm(); });
        document.getElementById("btnSavePdf").addEventListener("click", saveAsPdf);
        document.getElementById("reviewerName").addEventListener("input", syncSignatureNames);
    });
</script>
</body>
</html>